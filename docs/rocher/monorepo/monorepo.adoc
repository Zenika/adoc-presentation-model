= Le mono-repo produit... c'est la vie ! : mono-repo vs multi-repo
:revealjs_customtheme: ../../framework/themes/css/reveal-rocher-leaves-dark.css
:toc-title: Sommaire

:includedir: _slides
:imagesdir: images
:workspace: ../student/workspace

ifdef::backend-html5[]
link:{docname}.htm[icon:video-camera[] Slides]  link:{docname}.pdf[icon:file-pdf-o[] PDF] link:{docname}.adoc[icon:file-text-o[] Source]
endif::backend-html5[]

ifdef::backend-revealjs[]
[%notitle]
== Sommaire
toc::[]
endif::backend-revealjs[]

ifdef::backend-revealjs[]
[.bottom]
link:{docname}.pdf[icon:file-pdf-o[] PDF]  link:{docname}.html[icon:globe[] HTML]  link:{docname}.adoc[icon:file-alt[] Source]
endif::backend-revealjs[]

[.impact]
== D√©finition

"Mono-repo : (Anglicisme informatique) (Programmation informatique) Mode de d√©veloppement d'un programme sur un d√©p√¥t unique (par opposition √† une s√©paration en plusieurs packages)."
-- Wiktionnaire

== Mono-repo VS Multi-repo

Sur les internets, la bataille fait rage üòñü•ä

* link:https://medium.com/@mattklein123/monorepos-please-dont-e9a279be011b[Monorepos: Please don‚Äôt!]
* link:https://medium.com/@adamhjk/monorepo-please-do-3657e08a4b70[Monorepos: Please do!]
* link:https://medium.com/criteo-labs/why-you-dont-need-a-mono-repo-but-could-just-build-from-source-26bec7502af5[Why you don‚Äôt need a mono-repo but should just build from source]
* link:https://github.com/joelparkerhenderson/monorepo_vs_polyrepo[Monorepo vs. polyrepo]
* link:https://medium.com/outbrain-engineering/mono-repository-or-poly-repo-we-go-hybrid-314e1e17a7dd[Mono Repository or Poly Repo? We go Hybrid!]
* link:https://www.yegor256.com/2018/09/05/monolithic-repositories.html[Monolithic Repos Are Evil]

== Diff√©rentes organisations d'entreprise

[.maxed-image]
image::cicd-git.jpg[]

=== Un produit, plusieurs √©quipes

[.maxed-image]
include::_includes/1-comp-prod-multi-team.puml.adoc[]

=== Un produit, plusieurs √©quipes

[.maxed-image]
include::_includes/2-repo-comp-prod-multi-team.puml.adoc[]

=== Une √©quipe, plusieurs produits

[.maxed-image]
include::_includes/3-comp-team-multi-prod.puml.adoc[]

=== Un produit, une √©quipe

Sc√©nario simplifi√© consid√©r√© comme repr√©sentant notre entreprise.

[.big-image]
include::_includes/4-comp-one-team-one-prod.puml.adoc[]

ifdef::backend-revealjs[]
[.questions]
=== !
endif::backend-revealjs[]

== Mono-repo entreprise

[.maxed-image]
image::cicd-dev.jpg[]

=== Mono-repo entreprise : avantages

[%step]
* pas de version de d√©pendances interne √† maintenir
* pas de risque de d√©pendre de 2 versions d'une m√™me d√©pendance interne/externe
* une seule merge request pour une mise √† jour de d√©pendance interne
* build en continu simplifi√©
* int√©gration continue simplifi√©e
* recherche de code simplifi√©e
* analyse d'impact simplifi√©
* mise en commun de code simplifi√©e

=== Mono-repo entreprise : inconv√©nients

[%step]
* coordination importante
* outillage √† d√©veloper en interne
* besoin √©lev√© en resources (CPU, etc.)
* n√©cessite une couverture de test √©lev√©e
* le comportement des projets est impact√© instantan√©ment sur modification d'une d√©pendance
* L'acc√®s est donn√© √† l'ensemble du code source de l'entreprise

ifdef::backend-revealjs[]
[.questions]
=== !
endif::backend-revealjs[]

== Multi-repo modules (MuR) VS Mono-repo produit (MoRP)

[.maxed-image]
image::pilules-matrix.jpg[]

=== MuR : modification majeure de librairie interne

[.maxed-image]
include::_includes/mur-change-transverse.puml.adoc[]

=== MoRP : modification majeure de librairie interne

[.maxed-image]
include::_includes/morp-change-transverse.puml.adoc[]

=== MoRP : que des avantages sur le MuR

[%step]
* les avantages du mono-repo entreprise √©voqu√© pr√©c√©demment
* des modifications transverses grandement simplifi√©es (on l'a vu)
* des tests d'int√©gration / E2E pr√©-merge
* => une application logique du _Don't Repeat Yourself_ (DRY)

ifdef::backend-revealjs[]
[.questions]
=== !
endif::backend-revealjs[]

== Comment atteindre l'int√©gration continue ?

[.maxed-image]
image::cicd-idea.jpg[]

=== Pratique compl√©mentaire 1/3 : gitflow

[.maxed-image]
image::gitflow.png[]

=== Pratique compl√©mentaire 2/3 : trunk-based development

[.maxed-image]
image::tbd.png[]

=== Pratique compl√©mentaire 3/3 : Feature-flipping

[.maxed-image]
image::feature-flipping.png[]

=== Les pratiques conditionnent la fr√©quence

[%step]
* multi-repo modules + _gitflow_ => *int√©gration occasionnelle*
* mono-repo produit + _gitflow_ => *int√©gration fr√©quente*
* multi-repo modules + outillage sp√©cifique + _trunk-based development_ + _feature-flipping_ => *int√©gration fr√©quente √† continue*
* mono-repo produit + _trunk-based development_ + _feature-flipping_ => *int√©gration continue*

ifdef::backend-revealjs[]
[.questions]
=== !
endif::backend-revealjs[]

== Mono-repo produit : exemples

Exemples de mono-repo produit sous Gitlab et AWS/EKS (Kubernetes manag√©) : link:https://github.com/Zenika/zenixample[Zenixample (2019)] et link:https://gitlab.com/webvia/webvia[Webvia (2020)]

ifdef::backend-revealjs[]
[.questions]
=== !
endif::backend-revealjs[]

== Comment faire la transition vers un mono-repo produit ?

[%step]
* mettre en place un mono-repo sans impact gr√¢ce aux _submodules_ git
* mettre en place du d√©ploiement Kubernetes / GCP et des tests (simples) bout-en-bout
* migrer progressivement les projets en rempla√ßant les liens vers les _submodules_
* possibilit√© de garder les historiques git avec `git merge --allow-unrelated-histories`

ifdef::backend-revealjs[]
[.bubbles]
== !
endif::backend-revealjs[]
